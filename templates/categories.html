
{% extends "base.html" %}

{% block title %}Kategori Yönetimi{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>🏷️ Kategori Yönetimi</h2>
        <p class="text-muted">Hesaplarınıza kategori atayın ve yönetin</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>👥 Hesap Seçimi</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Hesap Türü:</label>
                    <div>
                        <input type="radio" id="giris_yapilan" name="accountType" value="giris_yapilan" checked>
                        <label for="giris_yapilan">🔐 Giriş Yapılan Hesaplar</label>
                    </div>
                    <div>
                        <input type="radio" id="hedef" name="accountType" value="hedef">
                        <label for="hedef">🎯 Hedef Hesaplar</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <input type="text" id="searchAccounts" class="form-control" placeholder="🔍 Hesap ara...">
                </div>
                
                <div class="mb-3">
                    <input type="checkbox" id="selectAll"> Tümünü Seç
                </div>
                
                <div id="accountsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Hesaplar buraya yüklenecek -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>🏷️ Kategori Atama</h5>
            </div>
            <div class="card-body">
                <form id="categoryForm">
                    <!-- Yaş Grubu -->
                    <div class="category-frame">
                        <h6 class="category-title">🧓 Yaş Grubu</h6>
                        <div>
                            <input type="radio" name="ageGroup" value="Belirtilmemiş" id="age_none" checked>
                            <label for="age_none">Belirtilmemiş</label>
                        </div>
                        <div>
                            <input type="radio" name="ageGroup" value="Genç (18-30)" id="age_young">
                            <label for="age_young">Genç (18-30)</label>
                        </div>
                        <div>
                            <input type="radio" name="ageGroup" value="Orta yaş (31-50)" id="age_middle">
                            <label for="age_middle">Orta yaş (31-50)</label>
                        </div>
                        <div>
                            <input type="radio" name="ageGroup" value="Yaşlı (50+)" id="age_old">
                            <label for="age_old">Yaşlı (50+)</label>
                        </div>
                    </div>

                    <!-- Cinsiyet -->
                    <div class="category-frame">
                        <h6 class="category-title">🚻 Cinsiyet</h6>
                        <div>
                            <input type="radio" name="gender" value="Belirtilmemiş" id="gender_none" checked>
                            <label for="gender_none">Belirtilmemiş</label>
                        </div>
                        <div>
                            <input type="radio" name="gender" value="Erkek" id="gender_male">
                            <label for="gender_male">Erkek</label>
                        </div>
                        <div>
                            <input type="radio" name="gender" value="Kadın" id="gender_female">
                            <label for="gender_female">Kadın</label>
                        </div>
                        <div>
                            <input type="radio" name="gender" value="Belirtmeyen / Diğer" id="gender_other">
                            <label for="gender_other">Belirtmeyen / Diğer</label>
                        </div>
                    </div>

                    <!-- Profil Fotoğrafı -->
                    <div class="category-frame">
                        <h6 class="category-title">📸 Profil Fotoğrafı</h6>
                        <div>
                            <input type="radio" name="profilePhoto" value="Belirtilmemiş" id="photo_none" checked>
                            <label for="photo_none">Belirtilmemiş</label>
                        </div>
                        <div>
                            <input type="radio" name="profilePhoto" value="Fotoğraf var" id="photo_yes">
                            <label for="photo_yes">Fotoğraf var</label>
                        </div>
                        <div>
                            <input type="radio" name="profilePhoto" value="Fotoğraf yok" id="photo_no">
                            <label for="photo_no">Fotoğraf yok</label>
                        </div>
                    </div>
                </form>

                <div class="mt-3">
                    <button type="button" class="btn btn-danger me-2" onclick="clearForm()">🗑️ Temizle</button>
                    <button type="button" class="btn btn-success" onclick="saveCategories()">💾 Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedAccounts = [];

// Sayfa yüklendiğinde hesapları getir
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
    
    // Hesap türü değiştiğinde
    document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', loadAccounts);
    });
});

function loadAccounts() {
    const accountType = document.querySelector('input[name="accountType"]:checked').value;
    
    fetch(`/api/accounts/${accountType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAccounts(data.accounts);
            } else {
                alert('Hesaplar yüklenemedi: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Hesaplar yüklenirken hata oluştu');
        });
}

function displayAccounts(accounts) {
    const container = document.getElementById('accountsList');
    container.innerHTML = '';
    
    accounts.forEach(account => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input account-checkbox" type="checkbox" value="${account}" id="acc_${account}">
            <label class="form-check-label" for="acc_${account}">${account}</label>
        `;
        container.appendChild(div);
    });
    
    // Checkbox event listener'ları ekle
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedAccounts);
    });
}

function updateSelectedAccounts() {
    selectedAccounts = [];
    document.querySelectorAll('.account-checkbox:checked').forEach(checkbox => {
        selectedAccounts.push(checkbox.value);
    });
}

function clearForm() {
    document.getElementById('categoryForm').reset();
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedAccounts = [];
}

function saveCategories() {
    if (selectedAccounts.length === 0) {
        alert('⚠️ En az bir hesap seçin!');
        return;
    }
    
    const formData = new FormData(document.getElementById('categoryForm'));
    const categories = {};
    
    // Form verilerini topla
    for (let [key, value] of formData.entries()) {
        if (key === 'ageGroup') categories['Yaş Grubu'] = value;
        else if (key === 'gender') categories['Cinsiyet'] = value;
        else if (key === 'profilePhoto') categories['Profil Fotoğrafı'] = value;
    }
    
    const accountType = document.querySelector('input[name="accountType"]:checked').value;
    
    const data = {
        accounts: selectedAccounts,
        categories: categories,
        account_type: accountType
    };
    
    fetch('/api/save_categories', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            clearForm();
        } else {
            alert('❌ Hata: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('❌ Kaydetme sırasında hata oluştu');
    });
}

// Tümünü seç/kaldır
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateSelectedAccounts();
});

// Arama fonksiyonu
document.getElementById('searchAccounts').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    document.querySelectorAll('#accountsList .form-check').forEach(item => {
        const label = item.querySelector('label').textContent.toLowerCase();
        item.style.display = label.includes(searchTerm) ? 'block' : 'none';
    });
});
</script>
{% endblock %}
