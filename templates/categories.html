
{% extends "base.html" %}

{% block title %}Kategori YÃ¶netimi{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>ğŸ·ï¸ Kategori YÃ¶netimi</h2>
        <p class="text-muted">HesaplarÄ±nÄ±za kategori atayÄ±n ve yÃ¶netin</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>ğŸ‘¥ Hesap SeÃ§imi</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Hesap TÃ¼rÃ¼:</label>
                    <div>
                        <input type="radio" id="giris_yapilan" name="accountType" value="giris_yapilan" checked>
                        <label for="giris_yapilan">ğŸ” GiriÅŸ YapÄ±lan Hesaplar</label>
                    </div>
                    <div>
                        <input type="radio" id="hedef" name="accountType" value="hedef">
                        <label for="hedef">ğŸ¯ Hedef Hesaplar</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <input type="text" id="searchAccounts" class="form-control" placeholder="ğŸ” Hesap ara...">
                </div>
                
                <div class="mb-3">
                    <input type="checkbox" id="selectAll"> TÃ¼mÃ¼nÃ¼ SeÃ§
                </div>
                
                <div id="accountsList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Hesaplar buraya yÃ¼klenecek -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>ğŸ·ï¸ Kategori Atama</h5>
            </div>
            <div class="card-body">
                <form id="categoryForm">
                    <!-- YaÅŸ Grubu -->
                    <div class="category-frame">
                        <h6 class="category-title">ğŸ§“ YaÅŸ Grubu</h6>
                        <div>
                            <input type="radio" name="ageGroup" value="BelirtilmemiÅŸ" id="age_none" checked>
                            <label for="age_none">BelirtilmemiÅŸ</label>
                        </div>
                        <div>
                            <input type="radio" name="ageGroup" value="GenÃ§ (18-30)" id="age_young">
                            <label for="age_young">GenÃ§ (18-30)</label>
                        </div>
                        <div>
                            <input type="radio" name="ageGroup" value="Orta yaÅŸ (31-50)" id="age_middle">
                            <label for="age_middle">Orta yaÅŸ (31-50)</label>
                        </div>
                        <div>
                            <input type="radio" name="ageGroup" value="YaÅŸlÄ± (50+)" id="age_old">
                            <label for="age_old">YaÅŸlÄ± (50+)</label>
                        </div>
                    </div>

                    <!-- Cinsiyet -->
                    <div class="category-frame">
                        <h6 class="category-title">ğŸš» Cinsiyet</h6>
                        <div>
                            <input type="radio" name="gender" value="BelirtilmemiÅŸ" id="gender_none" checked>
                            <label for="gender_none">BelirtilmemiÅŸ</label>
                        </div>
                        <div>
                            <input type="radio" name="gender" value="Erkek" id="gender_male">
                            <label for="gender_male">Erkek</label>
                        </div>
                        <div>
                            <input type="radio" name="gender" value="KadÄ±n" id="gender_female">
                            <label for="gender_female">KadÄ±n</label>
                        </div>
                        <div>
                            <input type="radio" name="gender" value="Belirtmeyen / DiÄŸer" id="gender_other">
                            <label for="gender_other">Belirtmeyen / DiÄŸer</label>
                        </div>
                    </div>

                    <!-- Profil FotoÄŸrafÄ± -->
                    <div class="category-frame">
                        <h6 class="category-title">ğŸ“¸ Profil FotoÄŸrafÄ±</h6>
                        <div>
                            <input type="radio" name="profilePhoto" value="BelirtilmemiÅŸ" id="photo_none" checked>
                            <label for="photo_none">BelirtilmemiÅŸ</label>
                        </div>
                        <div>
                            <input type="radio" name="profilePhoto" value="FotoÄŸraf var" id="photo_yes">
                            <label for="photo_yes">FotoÄŸraf var</label>
                        </div>
                        <div>
                            <input type="radio" name="profilePhoto" value="FotoÄŸraf yok" id="photo_no">
                            <label for="photo_no">FotoÄŸraf yok</label>
                        </div>
                    </div>
                </form>

                <div class="mt-3">
                    <button type="button" class="btn btn-danger me-2" onclick="clearForm()">ğŸ—‘ï¸ Temizle</button>
                    <button type="button" class="btn btn-success" onclick="saveCategories()">ğŸ’¾ Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedAccounts = [];

// Sayfa yÃ¼klendiÄŸinde hesaplarÄ± getir
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
    
    // Hesap tÃ¼rÃ¼ deÄŸiÅŸtiÄŸinde
    document.querySelectorAll('input[name="accountType"]').forEach(radio => {
        radio.addEventListener('change', loadAccounts);
    });
});

function loadAccounts() {
    const accountType = document.querySelector('input[name="accountType"]:checked').value;
    
    fetch(`/api/accounts/${accountType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAccounts(data.accounts);
            } else {
                alert('Hesaplar yÃ¼klenemedi: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Hesaplar yÃ¼klenirken hata oluÅŸtu');
        });
}

function displayAccounts(accounts) {
    const container = document.getElementById('accountsList');
    container.innerHTML = '';
    
    accounts.forEach(account => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input account-checkbox" type="checkbox" value="${account}" id="acc_${account}">
            <label class="form-check-label" for="acc_${account}">${account}</label>
        `;
        container.appendChild(div);
    });
    
    // Checkbox event listener'larÄ± ekle
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedAccounts);
    });
}

function updateSelectedAccounts() {
    selectedAccounts = [];
    document.querySelectorAll('.account-checkbox:checked').forEach(checkbox => {
        selectedAccounts.push(checkbox.value);
    });
}

function clearForm() {
    document.getElementById('categoryForm').reset();
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedAccounts = [];
}

function saveCategories() {
    if (selectedAccounts.length === 0) {
        alert('âš ï¸ En az bir hesap seÃ§in!');
        return;
    }
    
    const formData = new FormData(document.getElementById('categoryForm'));
    const categories = {};
    
    // Form verilerini topla
    for (let [key, value] of formData.entries()) {
        if (key === 'ageGroup') categories['YaÅŸ Grubu'] = value;
        else if (key === 'gender') categories['Cinsiyet'] = value;
        else if (key === 'profilePhoto') categories['Profil FotoÄŸrafÄ±'] = value;
    }
    
    const accountType = document.querySelector('input[name="accountType"]:checked').value;
    
    const data = {
        accounts: selectedAccounts,
        categories: categories,
        account_type: accountType
    };
    
    fetch('/api/save_categories', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            clearForm();
        } else {
            alert('âŒ Hata: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('âŒ Kaydetme sÄ±rasÄ±nda hata oluÅŸtu');
    });
}

// TÃ¼mÃ¼nÃ¼ seÃ§/kaldÄ±r
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateSelectedAccounts();
});

// Arama fonksiyonu
document.getElementById('searchAccounts').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    document.querySelectorAll('#accountsList .form-check').forEach(item => {
        const label = item.querySelector('label').textContent.toLowerCase();
        item.style.display = label.includes(searchTerm) ? 'block' : 'none';
    });
});
</script>
{% endblock %}
